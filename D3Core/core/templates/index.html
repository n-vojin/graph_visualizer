<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../static/style.css" />
    <title>Visualize Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../static/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-zoom/2.0.0/d3-zoom.min.js"></script>
  </head>

  <body>
    <!--NAVBAR-->
    <div class="navbar">
      <table>
        <tr>
          <th>Loader:</th>
          <th>Source:</th>
          <th>Visualization type:</th>
        </tr>
        <tr>
          <td>
            <select id="choose-loader">
              <option>JSON</option>
              <option>XML</option>
            </select>
          </td>
          <td>
            <input type="text" placeholder="Enter file name" id="file-name" />
          </td>
          <td>
            <select id="choose-visualizer">
              <option>Simple</option>
              <option>Block</option>
            </select>
          </td>
        </tr>
        <tr>
          <td></td>
          <td><button id="loadGraphBtn" >Load graph from file</button></td>
          <td><button id="visualiseButton">Visualize</button></td>
        </tr>
      </table>
      <div class="node-details">
        Node details:
        <!-- INSERT NODE DETAILS HERE -->
        <div id="details"></div>
      </div>
    </div>
    <div class="container">
      <!--TREE VIEW-->
      <div class="tree-view">
        Tree view
        <div id="graph-tree"></div>
        <!-- INSERT TREE HERE -->
      </div>
      <!--MAIN VIEW-->
      <div class="main-view">
        Main view
        <div id="graph"></div>
        <!--BIRD VIEW-->
        <div id="bird-view">Bird view</div>
      </div>
    </div>

<script>
    // JavaScript/jQuery function to handle the button click event
    $('#visualiseButton').click(function() {
        // Check if the #graph div is empty
        if ($('#graph').is(':empty')) {
            // If it's empty, make the AJAX POST request
            $.ajax({
                type: 'POST',
                url: "{% url 'visualise' %}",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'  // Including CSRF token for Django's security
                },
                success: function(response) {
                    // Update the div with the returned HTML content
                    $('#graph').html(response.html);
                },
                error: function(xhr, status, error) {
                    // Optional: Handle errors if the request fails
                    console.error("AJAX request failed: ", error);
                }
            });
        } else {
            console.log("Graph is already loaded, no need to reload.");
        }
    });
</script>

<!--TREE VIEW SCRIPT-->
<script>
    let globalGraph;
    let selectedTreeNode = null;

    function buildTree(graph) {
        globalGraph = graph;

        function getFirstAttribute(attributes) {
            for (let key in attributes) {
                if (attributes.hasOwnProperty(key) && typeof attributes[key] !== 'object') {
                    return `${key}: ${attributes[key]}`;
                }
            }
            return 'Unnamed';
        }

        function renderNode(nodeId) {
            const node = graph.nodes[nodeId];
            const attributes = node.attributes;
            const displayText = getFirstAttribute(attributes);

            let html = `<li class="collapsed" data-id="${nodeId}">
                <span class="node-name">${nodeId}</span>
                <div class="attributes" style="display:none;">`;

            for (const [key, value] of Object.entries(attributes)) {
                if (typeof value === 'object' && value !== null) {
                    html += `<div class="nested-data" data-nested='${JSON.stringify(value)}'><strong>${key}</strong></div>`;
                } else {
                    html += `<div><strong>${key}:</strong> ${value}</div>`;
                }
            }

            html += '</div>';

            const children = graph.edges.filter(edge => edge.source.node_id === nodeId)
                                        .map(edge => edge.destination.node_id);

            if (children.length > 0) {
                html += '<ul style="display:none;">';
                for (const childId of children) {
                    html += renderNode(childId);
                }
                html += '</ul>';
            }

            html += '</li>';
            return html;
        }

        const allNodes = new Set(Object.keys(graph.nodes));
        const childNodes = new Set(graph.edges.map(edge => edge.destination.node_id));
        const rootNodes = [...allNodes].filter(nodeId => !childNodes.has(nodeId));

        let treeHtml = '';
        for (const rootId of rootNodes) {
            treeHtml += renderNode(rootId);
        }

        return treeHtml;
    }

    function showNodeDetails(nodeId) {
        if (!globalGraph || !globalGraph.nodes[nodeId]) {
            $('#details').html('<p>Node not found</p>');
            return;
        }

        const node = globalGraph.nodes[nodeId];
        const attributes = node.attributes;

        let html = `<strong>Node ID:</strong> ${nodeId}<br>`;
        html += '<strong>Attributes:</strong><br>';
        html += '<table style="border-collapse: collapse; width: 100%;">';

        for (const [key, value] of Object.entries(attributes)) {
            html += '<tr style="border-bottom: 1px solid #ddd;">';
            html += `<td style="padding: 4px; vertical-align: top;"><strong>${key}:</strong></td>`;
            if (typeof value === 'object' && value !== null) {
                html += `<td style="padding: 4px;"><pre style="margin: 0; white-space: pre-wrap; word-break: break-all;">${JSON.stringify(value, null, 2)}</pre></td>`;
            } else {
                html += `<td style="padding: 4px;">${value}</td>`;
            }
            html += '</tr>';
        }

        html += '</table>';

        $('#details').html(html);
    }

    function expandToNode(nodeId) {
        const nodePath = [];
        let currentNode = $(`#graph-tree li[data-id="${nodeId}"]`);

        while (currentNode.length > 0) {
            nodePath.unshift(currentNode);
            currentNode = currentNode.parent().closest('li');
        }

        $('#graph-tree li').each(function() {
            if (!nodePath.includes($(this))) {
                $(this).removeClass('expanded').addClass('collapsed');
                $(this).children('ul, .attributes').hide();
            }
        });

        nodePath.forEach(node => {
            node.removeClass('collapsed').addClass('expanded');
            node.children('ul, .attributes').show();
        });
    }

    function selectTreeNode(nodeId) {
        if (selectedTreeNode) {
            $(`#graph-tree li[data-id="${selectedTreeNode}"] > .node-name`).css('color', '');
        }
        selectedTreeNode = nodeId;
        $(`#graph-tree li[data-id="${nodeId}"] > .node-name`).css('color', 'red');
    }

    $(document).ready(function() {
        $('#loadGraphBtn').click(function() {
            $('#graph-tree').empty();
            $('#details').empty();

            $.ajax({
                url: '/get_graph_data/',
                method: 'GET',
                success: function(data) {
                    const treeHtml = buildTree(data);
                    $('#graph-tree').html(treeHtml);
                },
                error: function(error) {
                    console.error('Error loading graph data:', error);
                }
            });
        });

        $('#graph-tree').on('click', 'li', function(e) {
            e.stopPropagation();
            const nodeId = $(this).data('id');

            if ($(this).hasClass('expanded')) {
                // If the node is already expanded, collapse it
                $(this).removeClass('expanded').addClass('collapsed');
                $(this).children('ul, .attributes').hide();
            } else {
                // If the node is collapsed, expand it and its parents
                expandToNode(nodeId);
            }

            selectTreeNode(nodeId);
            showNodeDetails(nodeId);
            highlightNode(nodeId); // This function is defined in the graph visualization script
        });

        $('#graph-tree').on('click', '.nested-data', function(e) {
            e.stopPropagation();
            const nestedData = JSON.parse($(this).attr('data-nested'));
            let html = '<ul>';
            for (const [key, value] of Object.entries(nestedData)) {
                if (typeof value === 'object' && value !== null) {
                    html += `<li class="nested-data" data-nested='${JSON.stringify(value)}'><strong>${key}</strong></li>`;
                } else {
                    html += `<li><strong>${key}:</strong> ${value}</li>`;
                }
            }
            html += '</ul>';
            $(this).html(html);
            $(this).removeClass('nested-data');
        });
    });
</script>


<!--TEMPORARY D3 SCRIPT WILL LATER BECOME PLUGIN-->

<!--  BIRD VIEW SCRIPT-->

  </body>
</html>
