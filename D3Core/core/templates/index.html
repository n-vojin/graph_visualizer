<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../static/style.css" />
    <title>Visualize Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  </head>

  <body>
    <!--NAVBAR-->
    <div class="navbar">
      <table>
        <tr>
          <th>Loader:</th>
          <th>Source:</th>
          <th>Visualization type:</th>
        </tr>
        <tr>
          <td>
            <select id="choose-loader">
              <option>JSON</option>
              <option>XML</option>
            </select>
          </td>
          <td>
            <input type="text" placeholder="Enter file name" id="file-name" />
          </td>
          <td>
            <select id="choose-visualizer">
              <option>Simple</option>
              <option>Block</option>
            </select>
          </td>
        </tr>
        <tr>
          <td></td>
          <td><button>Load file</button></td>
          <td><button id="loadGraphBtn">Visualize</button></td>
        </tr>
      </table>
      <div class="node-details">
        Node details:
        <!-- INSERT NODE DETAILS HERE -->
      </div>
    </div>
    <div class="container">
      <!--TREE VIEW-->
      <div class="tree-view">
        Tree view
        <ul id="graph-tree"></ul>
        <!-- INSERT TREE HERE -->
      </div>
      <!--MAIN VIEW-->
      <div class="main-view">
        Main view
        <!--BIRD VIEW-->
        <div id="bird-view">Bird view</div>
      </div>
    </div>
      <script>
        // This function will build the tree from the Graph object
        function buildTree(graph) {
            function renderNode(nodeId) {
                const node = graph.nodes[nodeId];
                let html = `<li class="collapsed" data-id="${nodeId}">
                    <span class="node-name">${node.attributes.name || nodeId}</span>
                    <div class="attributes" style="display:none;">
                        ${Object.entries(node.attributes).map(([key, value]) =>
                            `<div><strong>${key}:</strong> ${JSON.stringify(value)}</div>`
                        ).join('')}
                    </div>`;

                const children = graph.edges.filter(edge => edge.source.node_id === nodeId)
                                            .map(edge => edge.destination.node_id);

                if (children.length > 0) {
                    html += '<ul style="display:none;">';
                    for (const childId of children) {
                        html += renderNode(childId);
                    }
                    html += '</ul>';
                }

                html += '</li>';
                return html;
            }

            // Find root nodes (nodes with no incoming edges)
            const allNodes = new Set(Object.keys(graph.nodes));
            const childNodes = new Set(graph.edges.map(edge => edge.destination.node_id));
            const rootNodes = [...allNodes].filter(nodeId => !childNodes.has(nodeId));

            let treeHtml = '';
            for (const rootId of rootNodes) {
                treeHtml += renderNode(rootId);
            }

            return treeHtml;
        }

        $(document).ready(function() {
            $('#loadGraphBtn').click(function() {
                // For testing with dummy data that matches FlexibleJSONLoader output:
                const dummyData = {
                    name: "Test Graph",
                    nodes: {
                        "1": { node_id: "1", attributes: { name: "I'm parent", nested: { id: "2", name: "I'm nested", reference: "1" } } },
                        "2": { node_id: "2", attributes: { name: "I'm nested", reference: "1" } },
                        "3": { node_id: "3", attributes: { name: "I'm in an array", reference: "1" } },
                        "4": { node_id: "4", attributes: { name: "I'm also in an array" } },
                        "5": { node_id: "5", attributes: { name: "I have a single child", single_child: { id: "6", name: "I'm a single child" }, reference: ["3", "4"] } },
                        "6": { node_id: "6", attributes: { name: "I'm a single child" } }
                    },
                    edges: [
                        { source: { node_id: "1" }, destination: { node_id: "2" } },
                        { source: { node_id: "1" }, destination: { node_id: "3" } },
                        { source: { node_id: "1" }, destination: { node_id: "4" } },
                        { source: { node_id: "5" }, destination: { node_id: "6" } },
                        { source: { node_id: "5" }, destination: { node_id: "3" } },
                        { source: { node_id: "5" }, destination: { node_id: "4" } }
                    ]
                };

                const treeHtml = buildTree(dummyData);
                $('#graph-tree').html(treeHtml);

                // For later use with actual data from the server:
                // $.ajax({
                //     url: '/get_graph_data/',  // Replace with your actual endpoint
                //     method: 'GET',
                //     success: function(data) {
                //         const treeHtml = buildTree(data);
                //         $('#graph-tree').html(treeHtml);
                //     },
                //     error: function(error) {
                //         console.error('Error loading graph data:', error);
                //     }
                // });
            });

            $('#graph-tree').on('click', 'li', function(e) {
                e.stopPropagation();
                $(this).toggleClass('collapsed expanded');
                $(this).children('ul, .attributes').toggle();
                $('.selected').removeClass('selected');
                $(this).children('.node-name').addClass('selected');
            });
        });
      </script>
  </body>
</html>
