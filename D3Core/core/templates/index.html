<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../static/style.css" />
    <title>Visualize Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <body>
    <!--NAVBAR-->
    <div class="navbar">
      <table>
        <tr>
          <th>Loader:</th>
          <th>Source:</th>
          <th>Visualization type:</th>
        </tr>
        <tr>
          <td>
            <select id="choose-loader">
              <option>JSON</option>
              <option>XML</option>
            </select>
          </td>
          <td>
            <input type="text" placeholder="Enter file name" id="file-name" />
          </td>
          <td>
            <select id="choose-visualizer">
              <option>Simple</option>
              <option>Block</option>
            </select>
          </td>
        </tr>
        <tr>
          <td></td>
          <td><button>Load file</button></td>
          <td><button id="loadGraphBtn">Visualize</button></td>
        </tr>
      </table>
      <div class="node-details">
        Node details:
        <!-- INSERT NODE DETAILS HERE -->
      </div>
    </div>
    <div class="container">
      <!--TREE VIEW-->
      <div class="tree-view">
        Tree view
        <div id="graph-tree"></div>
        <!-- INSERT TREE HERE -->
      </div>
      <!--MAIN VIEW-->
      <div class="main-view">
        Main view
        <!--BIRD VIEW-->
        <div id="bird-view">Bird view</div>
      </div>
    </div>

<script>
    function buildTree(graph) {
        function getFirstAttribute(attributes) {
            for (let key in attributes) {
                if (attributes.hasOwnProperty(key) && typeof attributes[key] !== 'object') {
                    return `${key}: ${attributes[key]}`;
                }
            }
            return 'Unnamed';
        }

        function renderNode(nodeId) {
            const node = graph.nodes[nodeId];
            const attributes = node.attributes;
            const displayText = getFirstAttribute(attributes);

            let html = `<li class="collapsed" data-id="${nodeId}">
                <span class="node-name">${displayText}</span>
                <div class="attributes" style="display:none;">`;

            for (const [key, value] of Object.entries(attributes)) {
                if (typeof value === 'object' && value !== null) {
                    html += `<div class="nested-data" data-nested='${JSON.stringify(value)}'><strong>${key}</strong></div>`;
                } else {
                    html += `<div><strong>${key}:</strong> ${value}</div>`;
                }
            }

            html += '</div>';

            const children = graph.edges.filter(edge => edge.source.node_id === nodeId)
                                        .map(edge => edge.destination.node_id);

            if (children.length > 0) {
                html += '<ul style="display:none;">';
                for (const childId of children) {
                    html += renderNode(childId);
                }
                html += '</ul>';
            }

            html += '</li>';
            return html;
        }

        const allNodes = new Set(Object.keys(graph.nodes));
        const childNodes = new Set(graph.edges.map(edge => edge.destination.node_id));
        const rootNodes = [...allNodes].filter(nodeId => !childNodes.has(nodeId));

        let treeHtml = '';
        for (const rootId of rootNodes) {
            treeHtml += renderNode(rootId);
        }

        return treeHtml;
    }

    $(document).ready(function() {
        $('#loadGraphBtn').click(function() {
            // Clear existing tree view
            $('#graph-tree').empty();

            $.ajax({
                url: '/get_graph_data/',  // Make sure this URL is correct
                method: 'GET',
                success: function(data) {
                    const treeHtml = buildTree(data);
                    $('#graph-tree').html(treeHtml);
                },
                error: function(error) {
                    console.error('Error loading graph data:', error);
                }
            });
        });

        $('#graph-tree').on('click', 'li', function(e) {
            e.stopPropagation();
            $(this).toggleClass('collapsed expanded');
            $(this).children('ul, .attributes').toggle();
            $('.selected').removeClass('selected');
            $(this).children('.node-name').addClass('selected');
        });

        $('#graph-tree').on('click', '.nested-data', function(e) {
            e.stopPropagation();
            const nestedData = JSON.parse($(this).attr('data-nested'));
            let html = '<ul>';
            for (const [key, value] of Object.entries(nestedData)) {
                if (typeof value === 'object' && value !== null) {
                    html += `<li class="nested-data" data-nested='${JSON.stringify(value)}'><strong>${key}</strong></li>`;
                } else {
                    html += `<li><strong>${key}:</strong> ${value}</li>`;
                }
            }
            html += '</ul>';
            $(this).html(html);
            $(this).removeClass('nested-data');
        });
    });
</script>
  </body>
</html>
