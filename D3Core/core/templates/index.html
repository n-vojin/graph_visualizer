<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../static/style.css" />
    <title>Visualize Graph</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-zoom/2.0.0/d3-zoom.min.js"></script>
  </head>

  <body>
    <!--NAVBAR-->
    <div class="navbar">
      <table>
        <tr>
          <th>Loader:</th>
          <th>Source:</th>
          <th>Visualization type:</th>
        </tr>
        <tr>
          <td>
            <select id="choose-loader">
              <option>JSON</option>
              <option>XML</option>
            </select>
          </td>
          <td>
            <input type="text" placeholder="Enter file name" id="file-name" />
          </td>
          <td>
            <select id="choose-visualizer">
              <option>Simple</option>
              <option>Block</option>
            </select>
          </td>
        </tr>
        <tr>
          <td></td>
          <td><button>Load file</button></td>
          <td><button id="loadGraphBtn">Visualize</button></td>
        </tr>
      </table>
      <div class="node-details">
        Node details:
        <!-- INSERT NODE DETAILS HERE -->
      </div>
    </div>
    <div class="container">
      <!--TREE VIEW-->
      <div class="tree-view">
        Tree view
        <div id="graph-tree"></div>
        <!-- INSERT TREE HERE -->
      </div>
      <!--MAIN VIEW-->
      <div class="main-view">
        Main view
        <div id="graph"></div>
        <!--BIRD VIEW-->
        <div id="bird-view">Bird view</div>
      </div>
    </div>

<script>
    function buildTree(graph) {
        function getFirstAttribute(attributes) {
            for (let key in attributes) {
                if (attributes.hasOwnProperty(key) && typeof attributes[key] !== 'object') {
                    return `${key}: ${attributes[key]}`;
                }
            }
            return 'Unnamed';
        }

        function renderNode(nodeId) {
            const node = graph.nodes[nodeId];
            const attributes = node.attributes;
            const displayText = getFirstAttribute(attributes);

            let html = `<li class="collapsed" data-id="${nodeId}">
                <span class="node-name">${nodeId}</span>
                <div class="attributes" style="display:none;">`;

            //html += `<div><strong>Node ID:</strong> ${nodeId}</div>`;
            for (const [key, value] of Object.entries(attributes)) {
                if (typeof value === 'object' && value !== null) {
                    html += `<div class="nested-data" data-nested='${JSON.stringify(value)}'><strong>${key}</strong></div>`;
                } else {
                    html += `<div><strong>${key}:</strong> ${value}</div>`;
                }
            }

            html += '</div>';

            const children = graph.edges.filter(edge => edge.source.node_id === nodeId)
                                        .map(edge => edge.destination.node_id);

            if (children.length > 0) {
                html += '<ul style="display:none;">';
                for (const childId of children) {
                    html += renderNode(childId);
                }
                html += '</ul>';
            }

            html += '</li>';
            return html;
        }

        const allNodes = new Set(Object.keys(graph.nodes));
        const childNodes = new Set(graph.edges.map(edge => edge.destination.node_id));
        const rootNodes = [...allNodes].filter(nodeId => !childNodes.has(nodeId));

        let treeHtml = '';
        for (const rootId of rootNodes) {
            treeHtml += renderNode(rootId);
        }

        return treeHtml;
    }

    $(document).ready(function() {
        $('#loadGraphBtn').click(function() {
            // Clear existing tree view
            $('#graph-tree').empty();

            $.ajax({
                url: '/get_graph_data/',  // Make sure this URL is correct
                method: 'GET',
                success: function(data) {
                    const treeHtml = buildTree(data);
                    $('#graph-tree').html(treeHtml);
                },
                error: function(error) {
                    console.error('Error loading graph data:', error);
                }
            });
        });

        $('#graph-tree').on('click', 'li', function(e) {
            e.stopPropagation();
            $(this).toggleClass('collapsed expanded');
            $(this).children('ul, .attributes').toggle();
            $('.selected').removeClass('selected');
            $(this).children('.node-name').addClass('selected');
        });

        $('#graph-tree').on('click', '.nested-data', function(e) {
            e.stopPropagation();
            const nestedData = JSON.parse($(this).attr('data-nested'));
            let html = '<ul>';
            for (const [key, value] of Object.entries(nestedData)) {
                if (typeof value === 'object' && value !== null) {
                    html += `<li class="nested-data" data-nested='${JSON.stringify(value)}'><strong>${key}</strong></li>`;
                } else {
                    html += `<li><strong>${key}:</strong> ${value}</li>`;
                }
            }
            html += '</ul>';
            $(this).html(html);
            $(this).removeClass('nested-data');
        });
    });
</script>


<!--TEMPORARY D3 SCRIPT WILL LATER BECOME PLUGIN-->
<script>
        let simulation;
        let svg, g, birdSvg, birdG;
        let width = 900, height = 600;
        let birdWidth = 300, birdHeight = 200;

        function initializeGraph() {
            d3.select("#graph").selectAll("*").remove();
            d3.select("#bird-view").selectAll("*").remove();

            svg = d3.select("#graph")
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            g = svg.append("g");

            birdSvg = d3.select("#bird-view")
                .append("svg")
                .attr("width", birdWidth)
                .attr("height", birdHeight);

            birdG = birdSvg.append("g");

            // Add zoom behavior
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                    updateBirdViewport(event.transform);
                });

            svg.call(zoom);

            simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(d => d.id).distance(150)) // Increased distance
                .force("charge", d3.forceManyBody().strength(-100)) // Reduced strength
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collide", d3.forceCollide().radius(30)); // Added collision force

            return { g, birdG };
        }

        function loadGraph() {
            const { g, birdG } = initializeGraph();

            $.ajax({
                url: '/get_graph_data/',
                method: 'GET',
                dataType: 'json',
                success: function(graph) {
                    const nodes = Object.values(graph.nodes).map(node => ({
                        id: node.node_id,
                        x: Math.random() * width,
                        y: Math.random() * height
                    }));

                    const links = graph.edges.map(edge => ({
                        source: edge.source.node_id,
                        target: edge.destination.node_id
                    }));

                    const link = g.append("g")
                        .attr("stroke", "#999")
                        .attr("stroke-opacity", 0.6)
                        .selectAll("line")
                        .data(links)
                        .join("line")
                        .attr("stroke-width", 2);

                    const node = g.append("g")
                        .attr("stroke", "#fff")
                        .attr("stroke-width", 1.5)
                        .selectAll("circle")
                        .data(nodes)
                        .join("circle")
                        .attr("r", 10)
                        .attr("fill", "#69b3a2")
                        .call(drag(simulation));

                    node.append("title")
                        .text(d => d.id);

                    const labels = g.append("g")
                        .attr("class", "labels")
                        .selectAll("text")
                        .data(nodes)
                        .enter()
                        .append("text")
                        .text(d => d.id)
                        .attr("font-size", "10px")
                        .attr("dx", 12)
                        .attr("dy", 4);

                    // Bird's eye view elements
                    const birdLink = birdG.append("g")
                        .attr("stroke", "#999")
                        .attr("stroke-opacity", 0.6)
                        .selectAll("line")
                        .data(links)
                        .join("line")
                        .attr("stroke-width", 1);

                    const birdNode = birdG.append("g")
                        .selectAll("circle")
                        .data(nodes)
                        .join("circle")
                        .attr("r", 2)
                        .attr("fill", "#69b3a2");

                    // Add viewport rectangle to bird's eye view
                    const viewport = birdSvg.append("rect")
                        .attr("stroke", "red")
                        .attr("stroke-width", 2)
                        .attr("fill", "none");

                    simulation
                        .nodes(nodes)
                        .on("tick", ticked);

                    simulation.force("link")
                        .links(links);

                    function ticked() {
                        link
                            .attr("x1", d => d.source.x)
                            .attr("y1", d => d.source.y)
                            .attr("x2", d => d.target.x)
                            .attr("y2", d => d.target.y);

                        node
                            .attr("cx", d => d.x)
                            .attr("cy", d => d.y);

                        labels
                            .attr("x", d => d.x)
                            .attr("y", d => d.y);

                        // Update bird's eye view
                        birdLink
                            .attr("x1", d => d.source.x * birdWidth / width)
                            .attr("y1", d => d.source.y * birdHeight / height)
                            .attr("x2", d => d.target.x * birdWidth / width)
                            .attr("y2", d => d.target.y * birdHeight / height);

                        birdNode
                            .attr("cx", d => d.x * birdWidth / width)
                            .attr("cy", d => d.y * birdHeight / height);
                    }

                    // Initial update of bird's eye view viewport
                    updateBirdViewport(d3.zoomIdentity);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error fetching graph data:", textStatus, errorThrown);
                }
            });
        }

        function updateBirdViewport(transform) {
            const viewport = birdSvg.select("rect");
            const scale = transform.k;
            const translateX = transform.x;
            const translateY = transform.y;

            const vpWidth = birdWidth / scale;
            const vpHeight = birdHeight / scale;
            const vpX = (-translateX / scale) * (birdWidth / width);
            const vpY = (-translateY / scale) * (birdHeight / height);

            viewport
                .attr("x", vpX)
                .attr("y", vpY)
                .attr("width", vpWidth)
                .attr("height", vpHeight);
        }

        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        $(document).ready(function() {
            $("#loadGraphBtn").click(loadGraph);
            loadGraph(); // Initial load
        });
</script>

<!--  BIRD VIEW SCRIPT-->

  </body>
</html>
